<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Lyrics Learning - Cinematic Grid Experience</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --text-primary: #fff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --glow-intensity: 1;
            --grid-cols: 3;
            --grid-gap: 30px;
            --card-size: 200px;
        }

        body.light-mode {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --text-primary: #000;
            --text-secondary: rgba(0, 0, 0, 0.6);
            --border-color: rgba(0, 0, 0, 0.08);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --glow-intensity: 0.3;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.6s ease, color 0.6s ease;
        }

        /* Animated background particles */
        .particle-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 70%);
            border-radius: 50%;
            animation: float 20s infinite ease-in-out;
            opacity: 0;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100vh) translateX(100px) scale(1.5);
                opacity: 0;
            }
        }

        /* Main container */
        .main-container {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            padding: 100px 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 80px;
            animation: fadeInDown 1s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header h1 {
            font-size: 4em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            letter-spacing: -2px;
        }

        .header p {
            font-size: 1.4em;
            color: var(--text-secondary);
            font-weight: 300;
        }

        /* Grid controls */
        .grid-controls {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 100;
            display: flex;
            gap: 15px;
            animation: fadeIn 1s ease-out 0.5s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .control-btn {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
            font-size: 20px;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--shadow-color);
        }

        /* Title section */
        .title-section {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 60px;
            animation: fadeIn 0.8s ease-out 0.3s both;
        }

        .title-card {
            width: 250px;
            height: 250px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 30px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .title-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, transparent 30%, rgba(255,255,255,0.05) 70%);
            animation: bubble 8s ease-in-out infinite;
            pointer-events: none;
        }

        .title-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.3);
        }

        /* Simple, elegant highlighting for title cards */
        .title-card.highlighted {
            transform: translateY(-3px) scale(1.05);
            z-index: 10;
            position: relative;
        }
        
        .title-card.highlighted::after {
            content: '';
            position: absolute;
            inset: -3px;
            border: 2px solid var(--text-primary);
            border-radius: 10px;
            opacity: 0.6;
            pointer-events: none;
            animation: highlightPulse 1.5s ease-in-out infinite;
        }

        .title-card .pinyin {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
            letter-spacing: 2px;
            opacity: 0.9;
            color: var(--text-primary);
        }

        .title-card .hanzi {
            font-size: 80px;
            font-weight: 300;
            margin-bottom: 15px;
            line-height: 1;
            color: var(--text-primary);
        }

        .title-card .english {
            font-size: 18px;
            color: var(--text-secondary);
            text-align: center;
            font-style: italic;
            opacity: 0.8;
        }

        /* Grid container */
        .lyrics-grid {
            display: grid;
            grid-template-columns: repeat(var(--grid-cols), 1fr);
            gap: var(--grid-gap);
            max-width: calc(var(--grid-cols) * var(--card-size) + (var(--grid-cols) - 1) * var(--grid-gap));
            margin: 0 auto;
            position: relative;
        }

        /* Character cards */
        .character-card {
            width: var(--card-size);
            height: var(--card-size);
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 25px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            opacity: 0;
            animation: cardAppear 0.6s ease-out forwards;
            animation-delay: calc(var(--card-index) * 0.05s);
            animation-fill-mode: both;
        }
        
        body.light-mode .character-card {
            background: linear-gradient(135deg, rgba(0,0,0,0.03) 0%, rgba(0,0,0,0.01) 100%);
        }

        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            to {
                opacity: 1 !important;
                transform: scale(1) translateY(0);
            }
        }

        /* Bubble effect background */
        .character-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, transparent 30%, rgba(255,255,255,0.03) 70%);
            animation: bubble 6s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        


        @keyframes bubble {
            0%, 100% {
                transform: scale(0.9) rotate(0deg);
            }
            50% {
                transform: scale(1.1) rotate(180deg);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: translateY(-15px) scale(1.1);
            }
            50% {
                transform: translateY(-18px) scale(1.12);
            }
        }

        /* Card hover effects */
        .character-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.2);
        }

        /* Simple, elegant highlighting - copied from misc-lyrics.html */
        .character-card.highlighted {
            transform: translateY(-3px) scale(1.05);
            z-index: 10;
            position: relative;
        }
        
        .character-card.highlighted::after {
            content: '';
            position: absolute;
            inset: -3px;
            border: 2px solid var(--text-primary);
            border-radius: 10px;
            opacity: 0.6;
            pointer-events: none;
            animation: highlightPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes highlightPulse {
            0%, 100% {
                opacity: 0.6;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.02);
            }
        }

        /* Enhanced shadows for highlighted cards */
        .character-card.highlighted.tone-glow-1 {
            box-shadow: 0 8px 30px rgba(231, 76, 60, 0.3);
        }
        
        .character-card.highlighted.tone-glow-2 {
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.3);
        }
        
        .character-card.highlighted.tone-glow-3 {
            box-shadow: 0 8px 30px rgba(39, 174, 96, 0.3);
        }
        
        .character-card.highlighted.tone-glow-4 {
            box-shadow: 0 8px 30px rgba(52, 152, 219, 0.3);
        }
        
        .character-card.highlighted.tone-glow-neutral {
            box-shadow: 0 8px 30px rgba(149, 165, 166, 0.25);
        }

        /* Light mode enhanced shadows */
        body.light-mode .character-card.highlighted.tone-glow-1 {
            box-shadow: 0 8px 30px rgba(231, 76, 60, 0.4);
        }
        
        body.light-mode .character-card.highlighted.tone-glow-2 {
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.4);
        }
        
        body.light-mode .character-card.highlighted.tone-glow-3 {
            box-shadow: 0 8px 30px rgba(39, 174, 96, 0.4);
        }
        
        body.light-mode .character-card.highlighted.tone-glow-4 {
            box-shadow: 0 8px 30px rgba(52, 152, 219, 0.4);
        }
        
        body.light-mode .character-card.highlighted.tone-glow-neutral {
            box-shadow: 0 8px 30px rgba(149, 165, 166, 0.35);
        }

        /* Tone-based glows */
        .tone-glow-1 {
            box-shadow: 0 0 30px rgba(231, 76, 60, calc(0.4 * var(--glow-intensity)));
        }

        .tone-glow-2 {
            box-shadow: 0 0 30px rgba(255, 215, 0, calc(0.4 * var(--glow-intensity)));
        }

        .tone-glow-3 {
            box-shadow: 0 0 30px rgba(39, 174, 96, calc(0.4 * var(--glow-intensity)));
        }

        .tone-glow-4 {
            box-shadow: 0 0 30px rgba(52, 152, 219, calc(0.4 * var(--glow-intensity)));
        }

        .tone-glow-neutral {
            box-shadow: 0 0 30px rgba(149, 165, 166, calc(0.3 * var(--glow-intensity)));
        }



        /* Tone accent bar */
        .tone-accent {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50%;
            height: 4px;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .character-card:hover .tone-accent {
            width: 80%;
            height: 6px;
        }

        .tone-accent-1 {
            background: linear-gradient(90deg, #e74c3c, #ff6b6b);
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.5);
        }

        .tone-accent-2 {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
        }
        
        .tone-accent-3 {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            box-shadow: 0 2px 10px rgba(39, 174, 96, 0.5);
        }
        
        .tone-accent-4 {
            background: linear-gradient(90deg, #3498db, #5dade2);
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.5);
        }
        
        .tone-accent-neutral {
            background: linear-gradient(90deg, #95a5a6, #bdc3c7);
            box-shadow: 0 2px 10px rgba(149, 165, 166, 0.5);
        }

        /* Card content */
        .pinyin {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: 1px;
            opacity: 0.9;
            color: var(--text-primary);
            position: relative;
            z-index: 2;
        }

        .hanzi {
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 10px;
            line-height: 1;
            position: relative;
            color: var(--text-primary);
            z-index: 2;
        }

        .english {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            font-style: italic;
            opacity: 0.8;
            position: relative;
            z-index: 2;
        }

        /* Navigation hint */
        .nav-hint {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 30px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 20px;
            animation: slideUp 1s ease-out 1s both;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .nav-hint-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .key-indicator {
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid var(--border-color);
        }

        /* Modal styles */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 40px;
            border-radius: 25px;
            max-width: 500px;
            width: 90%;
            animation: modalAppear 0.3s ease-out;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            margin-bottom: 30px;
        }

        .modal-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .grid-options {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .grid-option {
            flex: 1;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .grid-option:hover,
        .grid-option.active {
            background: rgba(255,255,255,0.1);
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .grid-option.active {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        /* Theme toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border-color);
            border-radius: 30px;
            transition: all 0.3s ease;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #667eea;
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(30px);
        }

        /* Load more indicator */
        .load-more {
            margin-top: 80px;
            padding: 20px 40px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            font-size: 16px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease-out;
        }

        .load-more:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            :root {
                --grid-cols: 2;
                --card-size: 150px;
                --grid-gap: 20px;
            }

            .main-container {
                padding: 50px 20px;
            }

            .header h1 {
                font-size: 2.5em;
            }

            .grid-controls {
                top: 15px;
                right: 15px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .nav-hint {
                padding: 10px 20px;
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
            }

            .title-section {
                flex-direction: column;
                align-items: center;
                gap: 20px;
                margin-bottom: 40px;
            }

            .title-card {
                width: 200px;
                height: 200px;
                padding: 20px;
            }

            .title-card .pinyin {
                font-size: 18px;
                margin-bottom: 10px;
            }

            .title-card .hanzi {
                font-size: 60px;
                margin-bottom: 10px;
            }

            .title-card .english {
                font-size: 14px;
            }
        }

        /* Tone indicators in settings */
        .tone-legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .tone-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .tone-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor;
        }

        .dot-1 { background-color: #e74c3c; }
        .dot-2 { background-color: #ffd700; }
        .dot-3 { background-color: #27ae60; }
        .dot-4 { background-color: #3498db; }
        .dot-neutral { background-color: #95a5a6; }
    </style>
</head>
<body>
    <!-- Particle background -->
    <div class="particle-container" id="particleContainer"></div>

    <!-- Main content -->
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1>黃昏</h1>
            <p>Experience Chinese lyrics in a cinematic journey</p>
                </div>

        <!-- Grid controls -->
        <div class="grid-controls">
            <div class="control-btn" onclick="openSettings()" title="Settings">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"></path>
                </svg>
                </div>
            <div class="control-btn" onclick="toggleInfo()" title="Info">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
            </div>
        </div>

        <!-- Title section -->
        <div class="title-section" id="titleSection"></div>

        <!-- Lyrics grid -->
        <div class="lyrics-grid" id="lyricsGrid"></div>

        <!-- Load more button -->
        <button class="load-more" id="loadMoreBtn" onclick="loadMoreCards()">Load More Lyrics</button>

        <!-- Navigation hint -->
        <div class="nav-hint">
            <div class="nav-hint-item">
                <span class="key-indicator">WASD</span>
                <span>Grid navigation</span>
                                </div>
            <div class="nav-hint-item">
                <span class="key-indicator">TAB</span>
                <span>Next card</span>
            </div>
            <div class="nav-hint-item">
                <span class="key-indicator">SPACE</span>
                <span>Select card</span>
                            </div>
                        </div>
                    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <p>Customize your viewing experience</p>
                    </div>

            <div class="theme-toggle">
                <span>Light Mode</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                    <span class="toggle-slider"></span>
                </label>
                    </div>

            <h3 style="margin-bottom: 15px;">Grid Layout</h3>
            <div class="grid-options">
                <div class="grid-option" onclick="setGridLayout(2)" data-cols="2">
                    <div style="font-size: 24px; margin-bottom: 5px;">2×2</div>
                    <div style="font-size: 12px; opacity: 0.7;">Compact</div>
                                </div>
                <div class="grid-option active" onclick="setGridLayout(3)" data-cols="3">
                    <div style="font-size: 24px; margin-bottom: 5px;">3×3</div>
                    <div style="font-size: 12px; opacity: 0.7;">Default</div>
                            </div>
                <div class="grid-option" onclick="setGridLayout(4)" data-cols="4">
                    <div style="font-size: 24px; margin-bottom: 5px;">4×4</div>
                    <div style="font-size: 12px; opacity: 0.7;">Wide</div>
                        </div>
                    </div>

            <div class="tone-legend">
                <div class="tone-item">
                    <div class="tone-dot dot-1"></div>
                    <span>1st Tone (High)</span>
                                </div>
                <div class="tone-item">
                    <div class="tone-dot dot-2"></div>
                    <span>2nd Tone (Rising)</span>
                            </div>
                <div class="tone-item">
                    <div class="tone-dot dot-3"></div>
                    <span>3rd Tone (Low)</span>
                        </div>
                <div class="tone-item">
                    <div class="tone-dot dot-4"></div>
                    <span>4th Tone (Falling)</span>
            </div>
        </div>

            <button onclick="closeSettings()" style="width: 100%; margin-top: 30px; padding: 15px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer;">
                Close
            </button>
            </div>
        </div>

    <script>
        // Global variables
        let currentCardIndex = -1;
        let allCards = [];
        let titleCards = [];
        let currentBatch = 0;
        const CARDS_PER_BATCH = 18;
        let gridCols = 3;

        // Initialize particles
        function createParticles() {
            const container = document.getElementById('particleContainer');
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }

        // Tone detection functions
        function getToneClass(pinyin) {
            if (pinyin.includes('1') || pinyin.includes('ā') || pinyin.includes('ē') || pinyin.includes('ī') || pinyin.includes('ō') || pinyin.includes('ū') || pinyin.includes('ǖ')) {
                return 1;
            } else if (pinyin.includes('2') || pinyin.includes('á') || pinyin.includes('é') || pinyin.includes('í') || pinyin.includes('ó') || pinyin.includes('ú') || pinyin.includes('ǘ')) {
                return 2;
            } else if (pinyin.includes('3') || pinyin.includes('ǎ') || pinyin.includes('ě') || pinyin.includes('ǐ') || pinyin.includes('ǒ') || pinyin.includes('ǔ') || pinyin.includes('ǚ')) {
                return 3;
            } else if (pinyin.includes('4') || pinyin.includes('à') || pinyin.includes('è') || pinyin.includes('ì') || pinyin.includes('ò') || pinyin.includes('ù') || pinyin.includes('ǜ')) {
                return 4;
            } else {
                return 'neutral';
            }
        }

        function cleanPinyin(pinyin) {
            return pinyin.replace(/[1234]/g, '');
        }

        // Create title card
        function createTitleCard(char, index) {
            const card = document.createElement('div');
            card.className = 'title-card';
            card.style.setProperty('--card-index', index);

            const tone = getToneClass(char.pinyin);
            card.classList.add(`tone-glow-${tone}`);
            
            console.log(`🏗️ Creating title card ${index} with classes:`, card.classList.toString());
            console.log(`🎨 Tone for "${char.pinyin}": ${tone}`);

            card.innerHTML = `
                <div class="tone-accent tone-accent-${tone}"></div>
                <div class="pinyin tone-${tone}">${cleanPinyin(char.pinyin)}</div>
                <div class="hanzi">${char.hanzi}</div>
                <div class="english">${char.english}</div>
            `;

            card.tabIndex = 0;
            card.addEventListener('click', () => selectCard(index));
            card.addEventListener('keydown', (e) => {
                if (e.key === ' ' || e.key === 'Enter') {
                    e.preventDefault();
                    selectCard(index);
                }
            });

            return card;
        }

        // Create character card
        function createCharacterCard(char, index) {
            const card = document.createElement('div');
            card.className = 'character-card';
            card.style.setProperty('--card-index', index);

            const tone = getToneClass(char.pinyin);
            card.classList.add(`tone-glow-${tone}`);
            
            console.log(`🏗️ Creating regular card ${index} with classes:`, card.classList.toString());
            console.log(`🎨 Tone for "${char.pinyin}": ${tone}`);

            card.innerHTML = `
                <div class="tone-accent tone-accent-${tone}"></div>
                <div class="pinyin tone-${tone}">${cleanPinyin(char.pinyin)}</div>
                <div class="hanzi">${char.hanzi}</div>
                <div class="english">${char.english}</div>
            `;

            card.tabIndex = 0;
            card.addEventListener('click', () => selectCard(index + titleCards.length)); // Add offset for title cards
            card.addEventListener('keydown', (e) => {
                if (e.key === ' ' || e.key === 'Enter') {
                    e.preventDefault();
                    selectCard(index + titleCards.length); // Add offset for title cards
                }
            });

            return card;
        }

        // Card selection
        function selectCard(index) {
            
            // Clear all highlights - simple approach
            allCards.forEach((card, i) => {
                card.classList.remove('highlighted');
            });
            titleCards.forEach((card, i) => {
                console.log(`🧹 Removing highlight from title card ${i}:`, card.classList.toString());
                card.classList.remove('highlighted');
            });
            
            // Check if it's a title card
            if (index < titleCards.length) {
                console.log('🎯 Selecting TITLE card at index:', index);
                const titleCard = titleCards[index];
                console.log('📝 Title card classes before:', titleCard.classList.toString());
                titleCard.classList.add('highlighted');
                console.log('📝 Title card classes after:', titleCard.classList.toString());
                currentCardIndex = index;
                
                // Smooth scroll to card
                titleCard.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'center'
                });

                // Announce for accessibility
                announceCard(index, true);
                } else {
                // Regular card - simple highlighting approach
                const regularIndex = index - titleCards.length;
                console.log('🎯 Selecting REGULAR card at regularIndex:', regularIndex);
                if (allCards[regularIndex]) {
                    const regularCard = allCards[regularIndex];
                    console.log('📝 Regular card classes before:', regularCard.classList.toString());
                    regularCard.classList.add('highlighted');
                    console.log('📝 Regular card classes after:', regularCard.classList.toString());
                    
                    currentCardIndex = index;
                    
                    // Smooth scroll to card
                    regularCard.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'center'
                    });

                    // Announce for accessibility
                    announceCard(index, false);
                } else {
                    console.log('❌ No regular card found at index:', regularIndex);
                }
            }
        }

        function announceCard(index, isTitle) {
            const card = isTitle ? titleCards[index] : allCards[index - titleCards.length];
            const pinyin = card.querySelector('.pinyin').textContent;
            const hanzi = card.querySelector('.hanzi').textContent;
            const english = card.querySelector('.english').textContent;
            
            // Create announcement for screen readers
            const announcement = `${hanzi}, ${pinyin}, meaning ${english}`;
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(announcement);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                // speechSynthesis.speak(utterance);
            }
        }

        // Lyrics data
        const lyricsData = [
            // Title
                        { pinyin: 'huáng2', hanzi: '黃', english: 'yellow' },
            { pinyin: 'hūn1', hanzi: '昏', english: 'dusk' },
            // First verse
                        { pinyin: 'guò4', hanzi: '过', english: 'pass' },
                        { pinyin: 'wán2', hanzi: '完', english: 'finish' },
                        { pinyin: 'zhěng3', hanzi: '整', english: 'entire' },
                        { pinyin: 'gè4', hanzi: '个', english: 'classifier' },
                        { pinyin: 'xià4', hanzi: '夏', english: 'summer' },
            { pinyin: 'tiān1', hanzi: '天', english: 'day' },
                        { pinyin: 'yōu1', hanzi: '忧', english: 'worry' },
                        { pinyin: 'shāng1', hanzi: '伤', english: 'hurt' },
                        { pinyin: 'bìng4', hanzi: '并', english: 'and' },
                        { pinyin: 'méi2', hanzi: '没', english: 'not' },
                        { pinyin: 'yǒu3', hanzi: '有', english: 'have' },
                        { pinyin: 'hǎo3', hanzi: '好', english: 'good' },
                        { pinyin: 'yì1', hanzi: '一', english: 'one' },
            { pinyin: 'xiē1', hanzi: '些', english: 'some' },
            // Continue with more characters...
                        { pinyin: 'kāi1', hanzi: '开', english: 'drive' },
                        { pinyin: 'chē1', hanzi: '车', english: 'car' },
                        { pinyin: 'xíng2', hanzi: '行', english: 'travel' },
                        { pinyin: 'shǐ3', hanzi: '驶', english: 'drive' },
                        { pinyin: 'zài4', hanzi: '在', english: 'at' },
                        { pinyin: 'gōng1', hanzi: '公', english: 'public' },
                        { pinyin: 'lù4', hanzi: '路', english: 'road' },
                        { pinyin: 'wú2', hanzi: '无', english: 'no' },
                        { pinyin: 'jì4', hanzi: '际', english: 'edge' },
                        { pinyin: 'wú2', hanzi: '无', english: 'no' },
            { pinyin: 'biān1', hanzi: '边', english: 'border' },
                        { pinyin: 'yǒu3', hanzi: '有', english: 'have' },
                        { pinyin: 'lí2', hanzi: '离', english: 'leave' },
                        { pinyin: 'kāi1', hanzi: '开', english: 'open' },
                        { pinyin: 'zì4', hanzi: '自', english: 'self' },
                        { pinyin: 'jǐ3', hanzi: '己', english: 'self' },
                        { pinyin: 'de', hanzi: '的', english: 'particle' },
                        { pinyin: 'gǎn3', hanzi: '感', english: 'feel' },
            { pinyin: 'jué2', hanzi: '觉', english: 'sense' },
            // Add more verses...
                        { pinyin: 'chàng4', hanzi: '唱', english: 'sing' },
                        { pinyin: 'bù4', hanzi: '不', english: 'not' },
                        { pinyin: 'wán2', hanzi: '完', english: 'finish' },
                        { pinyin: 'yì1', hanzi: '一', english: 'one' },
                        { pinyin: 'shǒu3', hanzi: '首', english: 'classifier' },
            { pinyin: 'gē1', hanzi: '歌', english: 'song' },
                        { pinyin: 'pí2', hanzi: '疲', english: 'tired' },
                        { pinyin: 'juàn4', hanzi: '倦', english: 'weary' },
                        { pinyin: 'hái2', hanzi: '还', english: 'still' },
                        { pinyin: 'shèng4', hanzi: '剩', english: 'remain' },
                        { pinyin: 'xià4', hanzi: '下', english: 'below' },
                        { pinyin: 'hēi1', hanzi: '黑', english: 'black' },
                        { pinyin: 'yǎn3', hanzi: '眼', english: 'eye' },
                        { pinyin: 'quān1', hanzi: '圈', english: 'circle' }
        ];

        // Load title cards
        function loadTitleCards() {
            const titleSection = document.getElementById('titleSection');
            
            // Load first two cards as title cards (huang, hun)
            for (let i = 0; i < 2; i++) {
                const card = createTitleCard(lyricsData[i], i);
                titleSection.appendChild(card);
                titleCards.push(card);
            }
        }

        // Load cards in batches
        function loadCards(startIndex = 2) { // Start from index 2 to skip title cards
            const grid = document.getElementById('lyricsGrid');
            const endIndex = Math.min(startIndex + CARDS_PER_BATCH, lyricsData.length);

            console.log(`📦 Loading cards from ${startIndex} to ${endIndex-1}`);

            for (let i = startIndex; i < endIndex; i++) {
                const card = createCharacterCard(lyricsData[i], i - 2); // Adjust index for regular cards
                grid.appendChild(card);
                allCards.push(card);
                console.log(`✅ Added regular card ${i - 2} to allCards (data index: ${i})`);
            }

            console.log(`📊 Total regular cards now: ${allCards.length}`);

            // Hide load more button if all cards are loaded
            if (endIndex >= lyricsData.length) {
                document.getElementById('loadMoreBtn').style.display = 'none';
            }

            currentBatch++;
        }

        function loadMoreCards() {
            const startIndex = 2 + currentBatch * CARDS_PER_BATCH; // Account for title cards
            loadCards(startIndex);
        }

        // Navigation
        function navigateToNext() {
            const totalCards = titleCards.length + allCards.length;
            console.log('➡️ navigateToNext called - currentCardIndex:', currentCardIndex, 'totalCards:', totalCards);
            if (currentCardIndex < totalCards - 1) {
                selectCard(currentCardIndex + 1);
            } else if (currentBatch * CARDS_PER_BATCH < lyricsData.length) {
                // Load more cards if available
                console.log('📦 Loading more cards...');
                loadMoreCards();
                setTimeout(() => {
                    selectCard(currentCardIndex + 1);
                }, 300);
            }
        }

        function navigateToPrevious() {
            if (currentCardIndex > 0) {
                selectCard(currentCardIndex - 1);
            }
        }

        // Grid navigation
        function navigateUp() {
            if (currentCardIndex < 0) {
                selectCard(0);
                return;
            }
            
            // If we're in title section (first 2 cards)
            if (currentCardIndex < titleCards.length) {
                // Can't go up from title cards
                return;
            }
            
            // If we're in first row of regular cards, go to title cards
            const regularIndex = currentCardIndex - titleCards.length;
            if (regularIndex < gridCols) {
                // Go to title cards
                selectCard(regularIndex < titleCards.length ? regularIndex : titleCards.length - 1);
            } else {
                // Normal grid navigation
                const newIndex = currentCardIndex - gridCols;
                if (newIndex >= titleCards.length) {
                    selectCard(newIndex);
                }
            }
        }

        function navigateDown() {
            if (currentCardIndex < 0) {
                selectCard(0);
                return;
            }
            
            // If we're in title section
            if (currentCardIndex < titleCards.length) {
                // Go to first row of regular cards
                const targetIndex = titleCards.length + currentCardIndex;
                if (targetIndex < titleCards.length + allCards.length) {
                    selectCard(targetIndex);
                }
                return;
            }
            
            // Regular grid navigation
            const newIndex = currentCardIndex + gridCols;
            const totalCards = titleCards.length + allCards.length;
            if (newIndex < totalCards) {
                selectCard(newIndex);
            } else if (currentBatch * CARDS_PER_BATCH < lyricsData.length) {
                // Load more cards if we're at the bottom
                loadMoreCards();
                    setTimeout(() => {
                    const targetIndex = currentCardIndex + gridCols;
                    const newTotalCards = titleCards.length + allCards.length;
                    if (targetIndex < newTotalCards) {
                        selectCard(targetIndex);
                    }
                }, 300);
            }
        }

        function navigateLeft() {
            if (currentCardIndex < 0) {
                selectCard(0);
                return;
            }
            
            // If we're in title section
            if (currentCardIndex < titleCards.length) {
                if (currentCardIndex > 0) {
                    selectCard(currentCardIndex - 1);
                }
                return;
            }
            
            // Regular grid navigation
            const regularIndex = currentCardIndex - titleCards.length;
            if (regularIndex % gridCols !== 0) {
                selectCard(currentCardIndex - 1);
            }
        }

        function navigateRight() {
            if (currentCardIndex < 0) {
                selectCard(0);
                return;
            }
            
            // If we're in title section
            if (currentCardIndex < titleCards.length) {
                if (currentCardIndex < titleCards.length - 1) {
                    selectCard(currentCardIndex + 1);
                }
                return;
            }
            
            // Regular grid navigation
            const regularIndex = currentCardIndex - titleCards.length;
            const totalCards = titleCards.length + allCards.length;
            
            if ((regularIndex + 1) % gridCols !== 0 && currentCardIndex < totalCards - 1) {
                selectCard(currentCardIndex + 1);
            } else if ((regularIndex + 1) % gridCols === 0 && currentCardIndex < totalCards - 1) {
                // We're at the right edge but there are more cards
                selectCard(currentCardIndex + 1);
            }
        }

        // Settings functions
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function toggleInfo() {
            // You can implement an info modal similar to settings
            alert('Navigation:\n• WASD or Arrow Keys: Move in grid (Up/Down/Left/Right)\n• TAB: Next card in sequence\n• SHIFT+TAB: Previous card\n• SPACE: Select/activate card\n• ESC: Close modals');
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }

        function setGridLayout(cols) {
            gridCols = parseInt(cols);
            document.documentElement.style.setProperty('--grid-cols', cols);
            
            // Update active state
            document.querySelectorAll('.grid-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.dataset.cols == cols) {
                    opt.classList.add('active');
                }
            });

            // Adjust card size based on columns
            const sizes = { 2: '200px', 3: '180px', 4: '150px' };
            document.documentElement.style.setProperty('--card-size', sizes[cols] || '180px');
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            console.log('⌨️ Key pressed:', e.key);
            if (e.key === 'Tab') {
                e.preventDefault();
                if (e.shiftKey) {
                    navigateToPrevious();
                } else {
                    navigateToNext();
                }
            } else if (e.key === 'Escape') {
                closeSettings();
            } else if (e.key.toLowerCase() === 'w' || e.key === 'ArrowUp') {
                e.preventDefault();
                navigateUp();
            } else if (e.key.toLowerCase() === 's' || e.key === 'ArrowDown') {
                e.preventDefault();
                navigateDown();
            } else if (e.key.toLowerCase() === 'a' || e.key === 'ArrowLeft') {
                e.preventDefault();
                navigateLeft();
            } else if (e.key.toLowerCase() === 'd' || e.key === 'ArrowRight') {
                e.preventDefault();
                navigateRight();
            }
        });

        // DEBUG: Test card position - simplified
        function testWhiteOverlay() {
            console.log('🔍 DEBUG: Testing card position');
            
            if (allCards.length > 0) {
                const firstCard = allCards[0];
                const rect = firstCard.getBoundingClientRect();
                console.log('📐 First card position:', rect);
                console.log('✅ Card position logged');
            }
        }

        // DEBUG: Test function - simplified
        function testHighlight() {
            console.log('🔍 DEBUG: Testing highlight on first regular card');
            console.log('📊 allCards.length:', allCards.length);
            console.log('📊 titleCards.length:', titleCards.length);
            
            if (allCards.length > 0) {
                const firstRegularCard = allCards[0];
                console.log('🎯 First regular card classes:', firstRegularCard.classList.toString());
                
                // Clear all highlights first
                document.querySelectorAll('.highlighted').forEach(card => {
                    card.classList.remove('highlighted');
                });
                
                // Add highlight to first regular card - simple approach
                firstRegularCard.classList.add('highlighted');
                console.log('✅ Added highlight. New classes:', firstRegularCard.classList.toString());
                
                // Check computed styles
                const computedStyle = window.getComputedStyle(firstRegularCard);
                console.log('🎨 Computed background-color:', computedStyle.backgroundColor);
                console.log('🎨 Computed border:', computedStyle.border);
                console.log('🎨 Computed outline:', computedStyle.outline);
                
                // Force scroll to it
                firstRegularCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                console.log('❌ No regular cards found!');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeToggle').checked = true;
            }

            // Create particles
            createParticles();

            // Load title cards first
            loadTitleCards();
            
            // Load initial batch of regular cards
            loadCards(2);

            // Don't auto-select first card - let user control navigation
        });

        // Close modal on outside click
        document.getElementById('settingsModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeSettings();
            }
        });
    </script>
</body>
</html>